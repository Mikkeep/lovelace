{% extends 'exercise_admin/base.html' %}
{% load staticfiles %}
{% load i18n %}

{% block head-script %}
  <script>
    $(function() {
      $("#test-tabs").tabs();
      {% for test, stages in tests %}
        $("#stages-sortable-{{ test.id }}").sortable();
        $("#stages-sortable-{{ test.id }}").disableSelection();
        {% for stage, commands in stages %}
          $("#commands-sortable-{{ test.id }}-{{ stage.id }}").sortable();
          $("#commands-sortable-{{ test.id }}-{{ stage.id }}").disableSelection();
        {% endfor %}
      {% endfor %}
    });
  </script>
{% endblock %}

{% block heading %}
  <h1>Edit file upload exercise</h1>
{% endblock %}

{% block meta %}
  <section class="meta">
    <div class="breadcrumb"><a href="{% url 'admin:index' %}">Home</a> › <a href="{% url 'admin:app_list' 'courses' %}">Courses</a> › <a href="{% url 'admin:courses_fileuploadexercise_changelist' %}">File upload exercises</a> › <span id="exercise-name-breadcrumb">{{ exercise.name }}</span></div>
    <div class="top-button"><a href="{% url 'courses:sandbox' exercise.slug %}">View in sandbox</a></div>
    <div class="top-button"><a href="{% url 'admin:courses_fileuploadexercise_history' exercise.id %}">View history</a></div>
  </section>
{% endblock %}

{% block form-action-url %}{% url 'exercise_admin:file_upload_change' exercise.id %}{% endblock %}

{% block exercise-type-specific %}
  <section class="included-files">
    <h2>Included files</h2>
    
    <div>
      A pool of files available only for this exercise:
      <ol>
        {% for include_file in include_files %}
          <li>{{ include_file.default_name }} / {{ include_file.file_settings.purpose }}</li>
        {% endfor %}
      </ol>
    </div>

    <div>
      A pool of files specific to a course instance:
      <ol>
        {% for instance_file in instance_files %}
          <li>{{ instance_file.default_name }}</li>
        {% endfor %}
      </ol>
    </div>
  </section>

  <section class="tests">
    <h2>Tests</h2>
    
    <div id="test-tabs">
      <ol>
        {% for test, stages in tests %}
          <li><a href="#test-tabs-{{ test.id }}" id="test-{{ test.id }}">{{ test.name }}</a></li>
        {% endfor %}
        <li><button class="add-item" title="Adds a new test">+</button></li>
      </ol>

      {% for test, stages in tests %}
        <div id="test-tabs-{{ test.id }}">
          <h3>Test specific settings</h3>

          <div>
            <label for="test-{{ test.id }}-name">Test name:</label>
            <input type="text" id="test-{{ test.id }}-name" value="{{ test.name }}" onInput="test_name_changed(event);">
          </div>

          <div>Included files this test requires: &lt;a picker for selecting the files made available above; updates realtime&gt;</div>
            {% if test.required_files.count > 0 %}
              {% for req_file in test.required_files.all %}
                <div>{{ req_file.file_settings.name }}</div>
              {% endfor%}
            {% endif %}

          <h3>Test stage progression</h3>
          
          <div class="flex-container">
            <div class="left-side"><!-- left side, stages and commands -->
              <ol id="stages-sortable-{{ test.id }}">
                {% for stage, commands in stages %}
                  <li class="ui-state-default">
                    <span onClick="show_stagecmd_information(event);" id="stage-{{ stage.id }}">{{ stage.name }}</span>
                    <div>
                      <ol id="commands-sortable-{{ test.id }}-{{ stage.id }}">
                        {% for cmd, expected_outputs in commands %}
                          <li class="ui-state-default">
                            <span onClick="show_stagecmd_information(event);" id="command-{{ cmd.id }}" class="clickable-commandline">{{ cmd.command_line }}</span>
                          </li>
                        {% endfor %}
                      </ol>
                      <ol><li><button class="add-item" title="Adds a new test command">+</button></li></ol>
                    </div>
                  </li>
                {% endfor %}
              </ol>
              <ol><li><button class="add-item" title="Adds a new test stage">+</button></li></ol>
            </div>
            <div class="right-side"><!-- right side, information -->
              <div id="selection-information-container">
                <div class="selection-information" style="display: block;">
                  <h4>Stage/Command information</h4>
                  <p>Click a stage or command to select it and see the associated information.</p> 
                </div>
                
                {% for stage, commands in stages %}
                  <div id="stage-information-{{ stage.id }}" class="selection-information">
                    <h4>Stage {{ stage.ordinal_number }} information</h4>
                    <div class="form-row">
                      <label for="">Stage name: </label>
                      <input type="text" id="stage-{{ stage.id }}-name" value="{{ stage.name }}" onInput="stage_name_changed(event);">
                    </div>

                    <div class="form-row">
                      <label for="">Depends on: </label>
                      <select>
                        <optgroup>
                          <option>Only preceding</option>
                        </optgroup>
                        <optgroup>
                          <option>some stage</option>
                          <option>some other stage</option>
                        </optgroup>
                      </select>
                    </div>
                  </div>
                  
                  {% for command, expected_outputs in commands %}
                    <div id="command-information-{{ command.id }}" class="selection-information">
                      <h4>Stage {{ stage.ordinal_number }}, command {{ command.ordinal_number }} information</h4>
                      <div class="form-row">
                        <label for="command-{{ command.id }}-cmdline">Command line: </label>
                        <input type="text" id="command-{{ command.id }}-cmdline" value="{{ command.command_line }}" onInput="command_name_changed(event);">
                      </div>

                      <div class="form-cb-row">
                        <input type="checkbox" id="" value="{{ command.significant_stdout }}">
                        <label for="">Compare the generated stdout to reference</label>
                      </div>
                      <div class="form-cb-row">
                        <input type="checkbox" id="" value="{{ command.significant_stderr }}">
                        <label for="">Compare the generated stderr to reference</label>
                      </div>

                      <div class="form-row">
                        <label for="">Timeout: </label>
                        <input type="text" value="{{ command.timeout }}">
                      </div>

                      <div class="form-bigrow">
                        <label for="">STDIN</label>
                        <textarea id="" cols="40" rows="4">{{ command.input_text }}</textarea>
                      </div>

                      <div class="form-row">
                        <label for="">Expected return value: </label>
                        <input type="text" value="{{ command.return_value }}">
                      </div>
                    </div>
                  {% endfor %}
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    
    <div>
      maybe use d3.js to generate a nice graph of how the tests will be run?
    </div>
  </section>
{% endblock %}

{% block form-controls %}
  <section class="form-controls">
    <div><a href="blaah/delete" id="delete-exercise">delete</a></div>
    <input type="submit" id="save-exercise" value="save">
  </section>
{% endblock %}
