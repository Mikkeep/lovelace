{% extends 'exercise_admin/base.html' %}
{% load staticfiles %}
{% load i18n %}
{% load exercise_admin_extras %}

{% block head-script %}
  <script>
    $(function() {
      $("#test-tabs").tabs();
      {% for test, stages in tests %}
        $("#stages-sortable-{{ test.id }}").sortable();
        $("#stages-sortable-{{ test.id }}").disableSelection();
        {% for stage, commands in stages %}
          $("#commands-sortable-{{ test.id }}-{{ stage.id }}").sortable();
          $("#commands-sortable-{{ test.id }}-{{ stage.id }}").disableSelection();
        {% endfor %}
      {% endfor %}
    });
  </script>
{% endblock %}

{% block heading %}
  <h1>Edit file upload exercise</h1>
{% endblock %}

{% block meta %}
  <section class="meta">
    <div class="breadcrumb"><a href="{% url 'admin:index' %}">Home</a> › <a href="{% url 'admin:app_list' 'courses' %}">Courses</a> › <a href="{% url 'admin:courses_fileuploadexercise_changelist' %}">File upload exercises</a> › <span id="exercise-name-breadcrumb">{{ exercise.name }}</span></div>
    <div class="top-button"><a href="{% url 'courses:sandbox' exercise.slug %}">View in sandbox</a></div>
    <div class="top-button"><a href="{% url 'admin:courses_fileuploadexercise_history' exercise.id %}">View history</a></div>
  </section>
{% endblock %}

{% block exercise-type-specific-popups %}
{% endblock %}

{% block form-action-url %}{% url 'exercise_admin:file_upload_change' exercise.id %}{% endblock %}

{% block exercise-type-extra %}
  <div class="form-row">
    <label for="exercise-allowed_filenames">Allowed file names: </label>
    <input type="text" id="exercise-allowed_filenames" name="exercise_allowed_filenames" value="{{ exercise.allowed_filenames|join:"," }}">
  </div>
{% endblock %}

{% block exercise-type-specific %}
  <section class="included-files">
    <h2>Included files</h2>
    
    <div id="included-files">
      A pool of files available only for this exercise:
      <table id="included-files-table" class="files-table bordered-editable-area">
        <colgroup>
          <col class="file-name">
          <col class="file-purpose">
          <col class="file-description">
          <col class="edit-file">
          <col class="delete-file">
        </colgroup>
        <thead>
          <tr>
            <th>File name during test</th>
            <th>Used as</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for include_file in include_files %}
            {% include_file_tr include_file %}
          {% endfor %}
        </tbody>
      </table>
      <button type="button" class="add-item" title="Opens a popup window to add an included file" onclick="create_included_file_popup();">Add</button>

      <div id="include-file-popups">
        {% for include_file in include_files %}
          {% include_file_popup include_file "Edit included file: "|add:include_file.file_settings.name  %}
        {% endfor %}
      </div>
    </div>

    <div id="instance-files">
      A pool of files specific to a course instance, linked to this exercise:
      <table id="instance-files-table" class="files-table bordered-editable-area">
        <colgroup>
          <col class="file-name">
          <col class="file-purpose">
          <col class="file-description">
        </colgroup>
        <thead>
          <tr>
            <th>File name during test</th>
            <th>Used as</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for instance_file_link in instance_file_links %}
            <tr>
              <td>
                {{ instance_file_link.file_settings.name }}
              </td>
              <td>
                {{ instance_file_link.file_settings.get_purpose_display }}
              </td>
              <td>
                {{ instance_file_link.include_file.description }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="button" class="add-item" title="Opens a popup window to add and edit instance files" onclick="show_edit_instance_file_popup();">Add and edit</button>
    </div>
  </section>

  <section class="tests">
    <h2>Tests</h2>
    
    <div id="test-tabs">
      <ol>
        {% for test, stages in tests %}
          <li><a href="#test-tabs-{{ test.id }}" id="test-{{ test.id }}">{{ test.name }}</a></li>
        {% endfor %}
        <li class="test-tab-button-container"><button type="button" class="add-item" title="Adds a new test" onClick="add_test();">+</button></li>
      </ol>

      {% for test, stages in tests %}
        {% test_tab test stages %}
      {% endfor %}
    </div>
    
    <div>
      maybe use d3.js to generate a nice graph of how the tests will be run?
    </div>
  </section>
{% endblock %}

{% block form-controls %}
  <section class="form-controls">
    <div><a href="blaah/delete" id="delete-exercise">delete</a></div>
    <input type="submit" id="save-exercise" value="save">
  </section>
{% endblock %}

{% block templates %}
  <div display="none">
    {% test_tab True True True %}
  </div>
  <div display="none">
    <table>
      {% include_file_tr True True %}
    </table>
  </div>
  <div display="none">
    {% include_file_popup True True True %}
  </div>
{% endblock %}
