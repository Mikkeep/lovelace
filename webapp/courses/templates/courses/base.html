<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">

    {% load staticfiles %}
    {% load i18n %}
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic%26subset=latin,latin-ext">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Inconsolata">
    <link rel="icon" href="{% static 'courses/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'courses/style.css' %}">
    <link rel="stylesheet" href="{% static 'courses/small-screens.css' %}" media="(max-width: 1300px)">
    <link rel="stylesheet" href="{% static 'courses/syntax.css' %}">
    <link rel="stylesheet" href="{% static 'courses/blockcode.css' %}">
    <link rel="stylesheet" href="{% static 'courses/katex.min.css' %}">

    <script src="{% static 'courses/katex.min.js' %}"></script>
    <script src="{% static 'courses/jquery-2.1.1.min.js' %}"></script>
    <script src="{% static 'courses/jquery.slimscroll.min.js' %}"></script>
    <script src="{% static 'courses/blockcode.js' %}"></script>
    <script src="{% static 'courses/exercise.js' %}"></script>
    <script src="{% static 'courses/calendar.js' %}"></script>
    <script>
      $(document).ready(function() {
        addLineNumbers();
        setColumnWidths();
        setLineWidths();
        setPreHeights();

        add_exercise_form_callbacks();

        // Apply KaTeX to render all the math blocks
        $("div.tex").each(function(index) {
          katex.render($(this).text(), this);
        });

        // Build the table of contents
        var toc = $("nav.toc > div.list-div > ol");
        var current_toc_level = 1;
        //var topmost_ol = null;
        var headings = $.map([1, 2, 3, 4, 5, 6], function(i) {
          return "section.content h" + i + ".content-heading";
        }).join(", ");
        $(headings).each(function(index) {
          // TODO: http://stackoverflow.com/questions/123999/how-to-tell-if-a-dom-element-is-visible-in-the-current-viewport
          var new_toc_level = parseInt(this.tagName[1]);
          
          // TODO: Fix, ol can only contain li
          if (new_toc_level > current_toc_level) {
            for (var i = current_toc_level; i < new_toc_level; i += 1) { // >
              //var new_li = document.createElement("li");
              var new_ol = document.createElement("ol");
              toc.append(new_ol);
              //$(new_li).append(new_ol);
              //$(new_li).attr("class", "ol-container");

              toc = $(new_ol);
            }
          } else if (new_toc_level < current_toc_level) { // >
            for (var i = current_toc_level; i > new_toc_level; i -= 1) {
              toc = toc.parent();
            }
          }
          current_toc_level = new_toc_level;

          var li = document.createElement("li");
          var text = this.firstChild.nodeValue;
          var id = $(this).find("span.anchor-offset").first().attr("id");
          var anchor = document.createElement("a");
          $(anchor).attr("href", "#" + id)
          $(anchor).text(text);
          
          var h_parent = this.parentNode.parentNode;
          var icon, icon_img;
          if (h_parent.className == "embedded-page") {
            var status = $(h_parent).find("img").first().attr("class");
            if (status == "correct")
              icon = "{% static 'courses/correct-16.png' %}";
            else if (status == "incorrect")
              icon = "{% static 'courses/incorrect-16.png' %}";
            else if (status == "unanswered")
              icon = "{% static 'courses/unanswered-16.png' %}";
            icon_img = $(document.createElement("img"));
            icon_img.attr("src", icon);
          }
          $(li).append(anchor);
          if (icon)
            $(li).append(icon_img);

          toc.append(li);
        });

        // jQuery slimscroll for ToC
        $('#toc > div.list-div').slimScroll({
            height: '400px'
        });
      });
    </script>
    
    <title>{% block page-title %}RAiPPA{% endblock %}</title>
  </head>
  <body>
    <div id="container">
      <header>
        <div id="container-top">
          <div class="page-title">
            <h1>BRAND</h1>
            <h2>Something clever and insightful</h2>
          </div>
          <div class="user-actions">
            {% if user.is_active %}
              <div class="user-name">
                {% filter force_escape %}
                  {% firstof user.first_name user.username %}
                {% endfilter %}
              </div><div class="user-settings">
                <a href="/profile/">Settings</a>
              </div><div class="user-logout">
                <a href="/accounts/logout/">Log out</a>
              </div>
            {% else %}
              <div class="user-login">
                <a href="/accounts/login/">Log in</a>
              </div><div class="user-register">
                <a href="/accounts/register/">Create account</a>
              </div>
            {% endif %}
            
            {% if user.is_staff and user.is_active %}
              <div class="user-teacherstools">
                <a href="/admin/">Teacher's tools</a>
              </div>
            {% endif %}
          </div>{% comment %}login box{% endcomment %}
        </div>
      </header>
      
      {% block breadcrumb %}
      <nav class="breadcrumb">
        <div class="top-nav-container">
        <ul>
          {% for navurl in navurls %}
            {% if forloop.first %}
            {% else %}
              <div class="separator">Â»</div>
            {% endif %}

            {% if forloop.last %}
              <li class="last">{{ navurl.name }}</li>
            {% else %}
              <li><a href="{{ navurl.url }}">{{ navurl.name }}</a></li>
            {% endif %}
          {% endfor %}
        </ul>
        <div class="right-side">
          {# https://docs.djangoproject.com/en/1.7/topics/i18n/translation/#set-language-redirect-view #}
          <form class="language-picker">
            <select>
              <option value="fi">fi - suomi</option>
              <option value="en-UK">en - English (British)</option>
            </select>
          </form>
          <div class="vertical-separator"></div>
          <a onclick="$('#toc').toggle();" style="cursor:pointer;"><img src="{% static 'courses/toc.png' %}" title="Table of Contents"></a>
          <div class="vertical-separator"></div>
        </div>
        </div>
      </nav>
      {% endblock %}

      {% block toc %}{% comment %}TODO: Put inside a container (progress bar inside nav not semantic){% endcomment %}
      <nav class="toc" id="toc">
        <div>{% trans "Table of Contents" %}</div>
        <div class="list-div">
          <ol>
          </ol>
        </div>
        <div>{% trans "Completed:" %} <span id="completed-exercises">7</span>/<span id="total-exercises">10</span> {% trans "exercises" %}</div>
        <progress value="7" max="10"></progress>
      </nav>
      {% endblock %}
      
      <section class="content">
        {% block page-content %}
        {% endblock %}
      </section>
  
      <footer>
        <div class="column0">
          <p>Site design &amp; backend by Miikka Salminen</p>
          <p>Page contents available under Creative Commons license.</p>
        </div>
        <div class="column1">
          Powered by Python, Django and jQuery.
        </div>
      </footer>
    </div><!-- container -->

    <script>
      function isElementInViewport (el) {
        //special bonus for those using jQuery
        if (el instanceof jQuery) {
          el = el[0];
        }

        var rect = el.getBoundingClientRect();

        var result = (rect.top >= 0 &&
          rect.bottom <= $(window).height());
        return result;
      }

      function callback() {
        //your code here, e.g. console.log('is visible now');
      } 

      function fireIfElementVisible(el, callback) {
        return function () {
          if ( isElementInViewport(el) ) {
            callback();
          }
        }
      }

      //var handler = fireIfElementVisible(el, callback);
      var handler = function() {
        var headings = $(".content-heading");
        var topmost_found = false;
        headings.each(function(index) {
          var id = $(this).find("span.anchor-offset").first().attr("id");
          var link_in_toc = $("#toc li a[href=#" + id + "]").parent();
          if (isElementInViewport(this) && topmost_found == false) {
            $(link_in_toc).attr("class", "toc-visible");
            topmost_found = true;
          } else {
            $(link_in_toc).attr("class", "");
          }
        });
      };

      // Also use hashchange event to directly highlight the entered section!
      $(window).on('DOMContentLoaded load resize scroll', handler);
    </script>
  </body>
</html>
